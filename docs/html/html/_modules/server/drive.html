
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>server.drive &#8212; ngv  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for server.drive</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="k">as</span> <span class="nn">GPIO</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">Adafruit_PCA9685</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">server</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="n">pwm</span> <span class="o">=</span> <span class="n">Adafruit_PCA9685</span><span class="o">.</span><span class="n">PCA9685</span><span class="p">()</span>


<span class="n">MOTOR_STOP_PIN_NUM</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">MOTOR_STOP_PIN_NUM</span>
<span class="n">SERVO_PIN_NUM</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">SERVO_PIN_NUM</span>
<span class="n">MOTOR_PIN_NUM</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">MOTOR_PIN_NUM</span>
<span class="n">COMMU_PIN_NUM</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">COMMU_PIN_NUM</span>
<span class="n">SERVO_LEFT</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">SERVO_LEFT</span>
<span class="n">SERVO_MID</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">SERVO_MID</span>
<span class="n">SERVO_RIGHT</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">SERVO_RIGHT</span>
<span class="c1">## 가공 전 Steering Value</span>
<span class="n">__SERVO_LEFT</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">__SERVO_LEFT</span>
<span class="n">__SERVO_MID</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">__SERVO_MID</span>
<span class="n">__SERVO_RIGHT</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">__SERVO_RIGHT</span>
<span class="n">MOTOR_STOP</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">MOTOR_STOP</span>
<span class="n">MOTOR_FORWARD</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">MOTOR_FORWARD</span>
<span class="n">FIRST_FORWARD</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">FIRST_FORWARD</span>
<span class="n">FIRST_MOTOR_FORWARD</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">FIRST_MOTOR_FORWARD</span>
<span class="c1">## DISPLAY CONFIG</span>
<span class="n">DISPLAY_ON</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">DISPLAY_ON</span>

<span class="n">GPIO</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">BOARD</span><span class="p">)</span>
<span class="n">pwm</span><span class="o">.</span><span class="n">set_pwm</span><span class="p">(</span><span class="n">SERVO_PIN_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SERVO_MID</span><span class="p">)</span>

<div class="viewcode-block" id="detect_edges"><a class="viewcode-back" href="../../server.drive.html#server.drive.detect_edges">[docs]</a><span class="k">def</span> <span class="nf">detect_edges</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;영상의 edge를 찾는 함수이다.</span>
<span class="sd">    영상을 흑백 이진화 처리한 후 bilateral filter를 이용하여 노이즈를 제거한다.</span>
<span class="sd">    Canny Algorithm을 이용해 edge를 찾는다.</span>

<span class="sd">    :param frame: 웹캠으로 입력받은 edge를 찾을 영상</span>
<span class="sd">    :returns edges: 영상의 edge</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bilateralFilter</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="c1"># detect edges</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">edges</span></div>


<div class="viewcode-block" id="region_of_interest"><a class="viewcode-back" href="../../server.drive.html#server.drive.region_of_interest">[docs]</a><span class="k">def</span> <span class="nf">region_of_interest</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;입력받은 영상의 하단 절반을 관심 영역으로 자른다.</span>
<span class="sd">    영상과 같은 크기의 array를 생성한 후 영상의 관심 영역 부분을 복사하여 반환한다.</span>

<span class="sd">    :param edges: 관심 영역을 지정할 edge를 찾은 영상</span>
<span class="sd">    :returns cropped_edges: 복사한 관심 영역 영상</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

    <span class="c1"># only focus lower half of the screen</span>
    <span class="n">polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
    <span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">polygon</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="n">cropped_edges</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cropped_edges</span></div>


<div class="viewcode-block" id="detect_line_segments"><a class="viewcode-back" href="../../server.drive.html#server.drive.detect_line_segments">[docs]</a><span class="k">def</span> <span class="nf">detect_line_segments</span><span class="p">(</span><span class="n">cropped_edges</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;관심영역으로 자른 영상을 받아 차선으로 예상되는 선을 검출한다.</span>
<span class="sd">    입력 영상에서 임의의 점을 대상으로 차선을 검출하는 확률적 허프변환을 이용하여 차선을 찾는다.</span>

<span class="sd">    :param cropped_edges: 차선을 검출할 이진화된 영상</span>
<span class="sd">    :returns line_segments: 검출한 차선 윤곽선</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>
    <span class="n">min_threshold</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">line_segments</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HoughLinesP</span><span class="p">(</span><span class="n">cropped_edges</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">min_threshold</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">minLineLength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">maxLineGap</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line_segments</span></div>


<div class="viewcode-block" id="average_slope_intercept"><a class="viewcode-back" href="../../server.drive.html#server.drive.average_slope_intercept">[docs]</a><span class="k">def</span> <span class="nf">average_slope_intercept</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">line_segments</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;영상을 좌우 영역으로 나눠 양쪽 차선의 기울기와 y절편을 구한다.</span>
<span class="sd">    기울기가 음수일 경우 x1, x2 모두 왼쪽 영역에 있을때 왼쪽 차선,</span>
<span class="sd">    기울기가 음수가 아닐 경우 x1, x2 모두 오른쪽 영역에 있을때 오른쪽 차선으로 간주한다.</span>
<span class="sd">    이때 x1, x2가 같을 경우 수직이기에 건너뛴다.</span>

<span class="sd">    :param frame: 웹캠으로 입력받은 영상</span>
<span class="sd">    :param line_segments: 검출한 차선 윤곽선</span>
<span class="sd">    :returns lane_lines: 양측 차선</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">lane_lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">line_segments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;no line segments detected&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lane_lines</span>

    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">left_fit</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">right_fit</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">boundary</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">left_region_boundary</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">boundary</span><span class="p">)</span>
    <span class="n">right_region_boundary</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">boundary</span>

    <span class="k">for</span> <span class="n">line_segment</span> <span class="ow">in</span> <span class="n">line_segments</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="ow">in</span> <span class="n">line_segment</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x1</span> <span class="o">==</span> <span class="n">x2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;skipping vertical lines (slope = infinity)&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">x1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">slope</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">left_region_boundary</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&lt;</span> <span class="n">left_region_boundary</span><span class="p">:</span>
                    <span class="n">left_fit</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">right_region_boundary</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&gt;</span> <span class="n">right_region_boundary</span><span class="p">:</span>
                    <span class="n">right_fit</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">))</span>

    <span class="n">left_fit_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">left_fit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_fit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lane_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_points</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">left_fit_average</span><span class="p">))</span>

    <span class="n">right_fit_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">right_fit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_fit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lane_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_points</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">right_fit_average</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lane_lines</span></div>


<div class="viewcode-block" id="make_points"><a class="viewcode-back" href="../../server.drive.html#server.drive.make_points">[docs]</a><span class="k">def</span> <span class="nf">make_points</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;웹캠 영상을 입력받아 좌표를 생성한다.</span>
<span class="sd">    기울기와 y절편으로 x좌표를 찾는다.</span>
<span class="sd">    이때, 기울기가 0인경우 0으로 나눌 수 없기 때문에 작은 값인 0.1로 대신 계산한다.</span>

<span class="sd">    * x1 : 차선의 왼쪽 가로 좌표</span>
<span class="sd">    * x2 : 차선의 오른쪽 가로 좌표</span>
<span class="sd">    * y1 : 영상 바닥 세로 좌표</span>
<span class="sd">    * y2 : 영상 높이의 중간 세로 좌표</span>
<span class="sd">    </span>
<span class="sd">    :param frame: 웹캠으로 입력받은 영상</span>
<span class="sd">    :param line: 왼쪽 또는 오른쪽 차선</span>
<span class="sd">    :returns:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">line</span>

    <span class="n">y1</span> <span class="o">=</span> <span class="n">height</span>  <span class="c1"># bottom of the frame</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># make points from middle of the frame down</span>

    <span class="k">if</span> <span class="n">slope</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y1</span> <span class="o">-</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y2</span> <span class="o">-</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span></div>


<div class="viewcode-block" id="display_lines"><a class="viewcode-back" href="../../server.drive.html#server.drive.display_lines">[docs]</a><span class="k">def</span> <span class="nf">display_lines</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;영상에 차선을 표시한다.</span>

<span class="sd">    :param frame: 웹캠으로 입력받은 영상</span>
<span class="sd">    :param lines: 차선</span>
<span class="sd">    :param line_color: 차선의 색</span>
<span class="sd">    :param line_width: 차선 두께</span>
<span class="sd">    :returns line_image: 차선이 표시된 영상</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">line_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">line_image</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">line_color</span><span class="p">,</span> <span class="n">line_width</span><span class="p">)</span>

    <span class="n">line_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">line_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line_image</span></div>


<div class="viewcode-block" id="display_heading_line"><a class="viewcode-back" href="../../server.drive.html#server.drive.display_heading_line">[docs]</a><span class="k">def</span> <span class="nf">display_heading_line</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">steering_angle</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;차량의 steering angle을 직선으로 표시한다.</span>
<span class="sd">    </span>
<span class="sd">    :param frame: 웹캠으로 입력받은 영상</span>
<span class="sd">    :param steering_angle: 차량의 steering angle</span>
<span class="sd">    :param line_color: 표시할 직선의 색</span>
<span class="sd">    :param line_width: 표시할 직선의 두께</span>
<span class="sd">    :returns heading_image: steering angle이 표시된 영상</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">heading_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">steering_angle_radian</span> <span class="o">=</span> <span class="n">steering_angle</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">height</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">steering_angle_radian</span><span class="p">))</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">heading_image</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">line_color</span><span class="p">,</span> <span class="n">line_width</span><span class="p">)</span>
    <span class="n">heading_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">heading_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">heading_image</span></div>


<div class="viewcode-block" id="get_steering_angle"><a class="viewcode-back" href="../../server.drive.html#server.drive.get_steering_angle">[docs]</a><span class="k">def</span> <span class="nf">get_steering_angle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">lane_lines</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;웹캠에서 영상을 입력받아 steering angle을 구한다.</span>
<span class="sd">    차량이 양측 차선의 중앙으로 가도록 제어한다.</span>
<span class="sd">    입력 받은 영상에서 검출한 차선의 수에 따라 구한다.</span>

<span class="sd">    * x_offset : 양측 차선의 중간(가로축)과 화면 중앙의 차이</span>
<span class="sd">    * y_offset : 높이의 절반</span>

<span class="sd">    * 차선이 2개인 경우 : 두 차선의 중앙으로 향하도록 한다.</span>
<span class="sd">    * 차선이 1개인 경우 : 검출한 차선과 평행하도록 한다.</span>

<span class="sd">    :param frame: 웹캠으로 입력받은 영상</span>
<span class="sd">    :param int lane_lines: 차선의 수</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lane_lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">left_x2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lane_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">right_x2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lane_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_x2</span> <span class="o">+</span> <span class="n">right_x2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">mid</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">num_lane</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lane_lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lane_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">num_lane</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lane_lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">num_lane</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">angle_to_mid_radian</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">x_offset</span> <span class="o">/</span> <span class="n">y_offset</span><span class="p">)</span>
    <span class="n">angle_to_mid_deg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">angle_to_mid_radian</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">steering_angle</span> <span class="o">=</span> <span class="n">angle_to_mid_deg</span> <span class="o">+</span> <span class="mi">90</span>

    <span class="k">return</span> <span class="n">steering_angle</span><span class="p">,</span> <span class="n">num_lane</span></div>

<div class="viewcode-block" id="stop_forwarding"><a class="viewcode-back" href="../../server.drive.html#server.drive.stop_forwarding">[docs]</a><span class="k">def</span> <span class="nf">stop_forwarding</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="n">pwm</span><span class="o">.</span><span class="n">set_pwm</span><span class="p">(</span><span class="n">MOTOR_PIN_NUM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="n">MOTOR_STOP</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopped!&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">stop_forwarding</span><span class="p">)</span>

<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../server.drive.html#server.drive.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">before_angle</span> <span class="o">=</span> <span class="n">__SERVO_MID</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">,</span> <span class="mi">320</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">,</span> <span class="mi">240</span><span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">pwm</span><span class="o">.</span><span class="n">set_pwm_freq</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">gpio_function</span><span class="p">(</span><span class="n">MOTOR_STOP_PIN_NUM</span><span class="p">)</span> <span class="o">==</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">:</span>
            <span class="n">pwm</span><span class="o">.</span><span class="n">set_pwm</span><span class="p">(</span><span class="n">MOTOR_PIN_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOTOR_STOP</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped !&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">detect_edges</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">region_of_interest</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">line_segments</span> <span class="o">=</span> <span class="n">detect_line_segments</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>
        <span class="n">lane_lines</span> <span class="o">=</span> <span class="n">average_slope_intercept</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">line_segments</span><span class="p">)</span>
        <span class="n">lane_lines_image</span> <span class="o">=</span> <span class="n">display_lines</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">lane_lines</span><span class="p">)</span>
        <span class="n">steering_angle</span><span class="p">,</span> <span class="n">num_lane</span> <span class="o">=</span> <span class="n">get_steering_angle</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">lane_lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DISPLAY_ON</span><span class="p">:</span>
            <span class="n">heading_image</span> <span class="o">=</span> <span class="n">display_heading_line</span><span class="p">(</span><span class="n">lane_lines_image</span><span class="p">,</span> <span class="n">steering_angle</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="n">heading_image</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        deviation을 이용하여 oscillation(기준 4이하)을 잡아주고, outiler(기준 60이상)를 제거한다.</span>
<span class="sd">        이때, get_steering_angle에서 얻은 num_lane이 0일 경우 이전값으로 steering을 제어한다.</span>

<span class="sd">        *deviation : get_steering_angle에서의 steering_angle과 before_angle의 차</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">steering_angle</span> <span class="o">-</span> <span class="n">before_angle</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deviation</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">steering_angle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">steering_angle</span> <span class="o">+</span> <span class="n">before_angle</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">deviation</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">steering_angle</span> <span class="o">=</span> <span class="n">before_angle</span>

        <span class="k">if</span> <span class="n">num_lane</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">steering_angle</span> <span class="o">=</span> <span class="n">before_angle</span>

        <span class="n">before_angle</span> <span class="o">=</span> <span class="n">steering_angle</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;before_angle : </span><span class="si">{}</span><span class="s2"> steering_angle : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">before_angle</span><span class="p">,</span> <span class="n">steering_angle</span><span class="p">))</span>
        <span class="n">pwm</span><span class="o">.</span><span class="n">set_pwm</span><span class="p">(</span><span class="n">MOTOR_PIN_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MOTOR_FORWARD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">steering_angle</span> <span class="o">&gt;</span> <span class="n">__SERVO_RIGHT</span><span class="p">:</span>
            <span class="n">steering_angle</span> <span class="o">=</span> <span class="n">__SERVO_RIGHT</span>
        <span class="k">if</span> <span class="n">steering_angle</span> <span class="o">&lt;</span> <span class="n">__SERVO_LEFT</span><span class="p">:</span>
            <span class="n">steering_angle</span> <span class="o">=</span> <span class="n">__SERVO_LEFT</span>
        
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        * straight : 양 끝 값(100 / 80)에 가중치를 많이 두고 steering</span>
<span class="sd">        * right / left : 앞 부분에(100 - 115 / 65 - 80) 가중치를 많이 두고 steering</span>
<span class="sd">    </span>
<span class="sd">        * servo_pwm : 실제 차량을 제어하는 pwm값</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">steering_angle</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">steering_angle</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>  <span class="c1">#straight</span>
            <span class="n">servo_pwm</span> <span class="o">=</span> <span class="n">steering_angle</span> <span class="o">+</span> <span class="mi">280</span>
        <span class="k">elif</span> <span class="n">steering_angle</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1">#right</span>
            <span class="n">servo_pwm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0214</span> <span class="o">*</span> <span class="n">steering_angle</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">7.75</span> <span class="o">*</span> <span class="n">steering_angle</span> <span class="o">-</span> <span class="mi">195</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#left</span>
            <span class="n">servo_pwm</span> <span class="o">=</span> <span class="mf">0.0583</span> <span class="o">*</span> <span class="n">steering_angle</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">4.1488</span> <span class="o">*</span> <span class="n">steering_angle</span> <span class="o">+</span> <span class="mf">342.41</span>

        <span class="n">pwm</span><span class="o">.</span><span class="n">set_pwm</span><span class="p">(</span><span class="n">SERVO_PIN_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">servo_pwm</span><span class="p">))</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">video</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ngv</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../client.html">client package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../server.html">server package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>